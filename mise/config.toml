[settings]
verbose = false
experimental = true

[tools]
shellcheck = "latest"            # Shell script linter (mise-managed)

[env]
DOTFILES_ROOT = "{{env.DOTFILES_ROOT | default(value=env.HOME ~ '/Documents/repos/dotfiles')}}"
MISE_CONFIG_DIR = "{{config_root}}"
XDG_CONFIG_HOME = "{{env.XDG_CONFIG_HOME | default(value=env.HOME ~ '/.config')}}"
BREW_CLI_TOOLS = "stow git git-lfs eza bat fzf zoxide ripgrep fd zsh-autosuggestions zsh-syntax-highlighting atuin starship neovim emacs macchina taplo luacheck"
BREW_CASKS = "wezterm nikitabobko/tap/aerospace font-jetbrains-mono-nerd-font"

[tasks.bootstrap]
description = "Complete setup: install tools, tangle configs, and stow dotfiles"
depends = ["install", "tangle", "stow", "setup-tmux", "setup-zsh"]
run = "echo '‚úì Bootstrap complete! Dotfiles are ready.'"

[tasks.install]
description = "Install all tools (Homebrew CLI tools and casks)"
depends = ["install-brew-tools", "install-brew-casks"]
run = [
    "mkdir -p {{env.XDG_CONFIG_HOME}}",
    "echo '‚úì All tools installed'",
]

[tasks.install-brew-tools]
description = "Install CLI tools via Homebrew"
run = '''
brew install {{env.BREW_CLI_TOOLS}} && \
echo '‚úì Homebrew CLI tools installed'
'''

[tasks.install-brew-casks]
description = "Install GUI applications via Homebrew casks"
run = '''
brew install --cask {{env.BREW_CASKS}} && \
echo '‚úì Homebrew casks installed'
'''

[tasks.update]
description = "Update all tools to latest versions"
run = [
    "brew upgrade",
    "echo '‚úì All tools updated'",
]

[tasks.tangle]
description = "Tangle all Org mode configuration files"
dir = "{{env.DOTFILES_ROOT}}"
run = '''
emacs --batch --eval "(progn \
  (require 'org) \
  (dolist (file '(\"{{env.DOTFILES_ROOT}}/tmux/README.org\" \
                  \"{{env.DOTFILES_ROOT}}/wezterm/README.org\" \
                  \"{{env.DOTFILES_ROOT}}/aerospace/README.org\" \
                  \"{{env.DOTFILES_ROOT}}/starship/README.org\" \
                  \"{{env.DOTFILES_ROOT}}/git/README.org\" \
                  \"{{env.DOTFILES_ROOT}}/nvim/README.org\" \
                  \"{{env.DOTFILES_ROOT}}/emacs/config.org\" \
                  \"{{env.DOTFILES_ROOT}}/zsh/README.org\" \
                  \"{{env.DOTFILES_ROOT}}/mise/README.org\")) \
    (when (file-exists-p file) \
      (message \"Tangling %s...\" file) \
      (with-current-buffer (find-file-noselect file) \
        (org-babel-tangle) \
        (kill-buffer)))))"
'''
outputs = ["echo '‚úì All configurations tangled'"]

[tasks.stow]
description = "Set up dotfiles using stow (creates symlinks in XDG config directory)"
depends = ["tangle"]
dir = "{{env.DOTFILES_ROOT}}"
run = [
    "stow .",
    "echo '‚úì Dotfiles symlinked to {{env.XDG_CONFIG_HOME}}'",
]

[tasks.stow-verify]
description = "Verify stow configuration (dry run)"
dir = "{{env.DOTFILES_ROOT}}"
run = "stow -nv ." # "stow --adopt -t ~/.config -nv ."

[tasks.restow]
description = "Re-stow all configurations"
dir = "{{env.DOTFILES_ROOT}}"
run = [
    "stow -R .", # "stow -Rt ~/.config .",
    "echo '‚úì Configurations re-stowed'",
]

[tasks.destow]
description = "Remove all symlinks created by stow (with confirmation)"
dir = "{{env.DOTFILES_ROOT}}"
run = '''
echo "‚ö†Ô∏è  This will remove all symlinks in {{env.XDG_CONFIG_HOME}}"
echo "The following configurations will be unstowed:"
stow -D -nv . 2>&1 | grep "UNLINK:" || echo "  (no symlinks to remove)"
echo ""
read -p "Continue with destow? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    stow -D . && echo "‚úì Symlinks removed"
else
    echo "Destow cancelled"
    exit 1
fi
'''

[tasks.stow-tool]
description = "Stow a specific tool's configuration"
dir = "{{env.DOTFILES_ROOT}}"
run = '''
TOOL="{{arg(name="tool")}}"
if [[ -z "$TOOL" ]]; then
    echo "Usage: mise run stow-tool <tool-name>"
    echo "Available tools: nvim, tmux, wezterm, aerospace, starship, emacs, git, zsh, mise"
    exit 1
fi

if [[ ! -d "$TOOL" ]]; then
    echo "Error: Tool directory '$TOOL' not found"
    echo "Available tools: nvim, tmux, wezterm, aerospace, starship, emacs, git, zsh, mise"
    exit 1
fi

stow "$TOOL" && echo "‚úì $TOOL configuration stowed to {{env.XDG_CONFIG_HOME}}"
'''

[tasks.restow-tool]
description = "Restow a specific tool's configuration"
dir = "{{env.DOTFILES_ROOT}}"
run = '''
TOOL="{{arg(name="tool")}}"
if [[ -z "$TOOL" ]]; then
    echo "Usage: mise run restow-tool <tool-name>"
    echo "Available tools: nvim, tmux, wezterm, aerospace, starship, emacs, git, zsh, mise"
    exit 1
fi

if [[ ! -d "$TOOL" ]]; then
    echo "Error: Tool directory '$TOOL' not found"
    exit 1
fi

stow -R "$TOOL" && echo "‚úì $TOOL configuration restowed"
'''

[tasks.destow-tool]
description = "Remove symlinks for a specific tool"
dir = "{{env.DOTFILES_ROOT}}"
run = '''
TOOL="{{arg(name="tool")}}"
if [[ -z "$TOOL" ]]; then
    echo "Usage: mise run destow-tool <tool-name>"
    echo "Available tools: nvim, tmux, wezterm, aerospace, starship, emacs, git, zsh, mise"
    exit 1
fi

if [[ ! -d "$TOOL" ]]; then
    echo "Error: Tool directory '$TOOL' not found"
    exit 1
fi

stow -D "$TOOL" && echo "‚úì $TOOL symlinks removed"
'''

[tasks.validate]
description = "Validate all configuration files"
run = '''
echo "Validating configurations..."
FAILED=0

# Validate TOML files
echo "‚Üí Checking TOML files..."
[[ -f aerospace/aerospace.toml ]] && taplo check aerospace/aerospace.toml 2>/dev/null || { echo "  ‚úó aerospace.toml invalid or missing"; FAILED=1; }
[[ -f starship/starship.toml ]] && taplo check starship/starship.toml 2>/dev/null || { echo "  ‚úó starship.toml invalid or missing"; FAILED=1; }
[[ $FAILED -eq 0 ]] && echo "  ‚úì TOML files valid"

# Validate Lua files
echo "‚Üí Checking Lua files..."
[[ -f wezterm/wezterm.lua ]] && luacheck wezterm/wezterm.lua 2>/dev/null || { echo "  ‚úó wezterm.lua invalid or missing"; FAILED=1; }
[[ -d nvim ]] && luacheck nvim/ --quiet 2>/dev/null || { echo "  ‚úó nvim config invalid or missing"; FAILED=1; }
[[ $FAILED -eq 0 ]] && echo "  ‚úì Lua files valid"

# Validate shell configs
echo "‚Üí Checking shell scripts..."
[[ -f zsh/.zshrc ]] && shellcheck -x zsh/.zshrc 2>/dev/null || { echo "  ‚úó .zshrc has issues or missing"; FAILED=1; }
[[ $FAILED -eq 0 ]] && echo "  ‚úì Shell scripts valid"

# Validate tmux config
echo "‚Üí Checking tmux config..."
[[ -f tmux/tmux.conf ]] && tmux source-file tmux/tmux.conf 2>/dev/null || { echo "  ‚úó tmux.conf invalid or missing"; FAILED=1; }
[[ $FAILED -eq 0 ]] && echo "  ‚úì tmux config valid"

# Validate nvim config (headless check)
echo "‚Üí Checking neovim config..."
nvim --headless -c 'qa' 2>/dev/null || { echo "  ‚úó nvim config invalid"; FAILED=1; }
[[ $FAILED -eq 0 ]] && echo "  ‚úì nvim config valid"

# Validate emacs config
echo "‚Üí Checking emacs config..."
emacs --batch --eval "(kill-emacs)" 2>/dev/null || { echo "  ‚úó emacs config invalid"; FAILED=1; }
[[ $FAILED -eq 0 ]] && echo "  ‚úì emacs config valid"

if [[ $FAILED -eq 0 ]]; then
    echo "‚úì All validations passed"
    exit 0
else
    echo "‚úó Some validations failed"
    exit 1
fi
'''

[tasks.validate-tool]
description = "Validate a specific tool's configuration"
run = '''
TOOL="{{arg(name="tool")}}"
if [[ -z "$TOOL" ]]; then
    echo "Usage: mise run validate-tool <tool-name>"
    echo "Available tools: tmux, nvim, emacs, aerospace, starship, wezterm, zsh"
    exit 1
fi

case "$TOOL" in
    tmux)
        echo "Validating tmux configuration..."
        tmux source-file tmux/tmux.conf 2>/dev/null && echo "‚úì tmux config valid" || { echo "‚úó tmux config invalid"; exit 1; }
        ;;
    nvim)
        echo "Validating neovim configuration..."
        luacheck nvim/ --quiet 2>/dev/null && echo "‚úì nvim Lua valid" || { echo "‚úó nvim Lua invalid"; exit 1; }
        nvim --headless -c 'qa' 2>/dev/null && echo "‚úì nvim config valid" || { echo "‚úó nvim config invalid"; exit 1; }
        ;;
    emacs)
        echo "Validating emacs configuration..."
        emacs --batch --eval "(kill-emacs)" 2>/dev/null && echo "‚úì emacs config valid" || { echo "‚úó emacs config invalid"; exit 1; }
        ;;
    aerospace)
        echo "Validating aerospace configuration..."
        taplo check aerospace/aerospace.toml 2>/dev/null && echo "‚úì aerospace.toml valid" || { echo "‚úó aerospace.toml invalid"; exit 1; }
        ;;
    starship)
        echo "Validating starship configuration..."
        taplo check starship/starship.toml 2>/dev/null && echo "‚úì starship.toml valid" || { echo "‚úó starship.toml invalid"; exit 1; }
        ;;
    wezterm)
        echo "Validating wezterm configuration..."
        luacheck wezterm/wezterm.lua 2>/dev/null && echo "‚úì wezterm.lua valid" || { echo "‚úó wezterm.lua invalid"; exit 1; }
        ;;
    zsh)
        echo "Validating zsh configuration..."
        [[ -f zsh/.zshrc ]] && shellcheck -x zsh/.zshrc 2>/dev/null && echo "‚úì .zshrc valid" || { echo "‚úó .zshrc has issues"; exit 1; }
        ;;
    *)
        echo "Unknown tool: $TOOL"
        echo "Available tools: tmux, nvim, emacs, aerospace, starship, wezterm, zsh"
        exit 1
        ;;
esac
'''

[tasks.doctor]
description = "Check mise and tool installation status"
run = [
    "mise doctor",
    "mise list",
]

[tasks.setup-tmux]
description = "Install TMUX Plugin Manager (TPM)"
run = [
    "git clone https://github.com/tmux-plugins/tpm {{env.XDG_CONFIG_HOME}}/tmux/plugins/tpm || echo 'TPM already installed'",
    "echo '‚úì TPM installed. Press prefix + I in tmux to install plugins'",
]

[tasks.reload-tmux]
description = "Reload TMUX configuration"
run = "tmux source-file {{env.XDG_CONFIG_HOME}}/tmux/tmux.conf || echo 'Start tmux first, then reload with prefix + R'"

[tasks.reload-aerospace]
description = "Reload AeroSpace configuration"
run = [
    "aerospace reload-config",
    "echo '‚úì AeroSpace configuration reloaded'",
]

[tasks.setup-zsh]
description = "Set ZDOTDIR in ~/.zshenv and create .hushlogin to suppress login messages"
run = '''
echo 'export ZDOTDIR="{{env.XDG_CONFIG_HOME}}/zsh"' > ~/.zshenv && \
touch ~/.hushlogin && \
echo '‚úì ZDOTDIR set in ~/.zshenv and .hushlogin created'
'''

[tasks.watch]
description = "Watch org files and auto-tangle on changes"
dir = "{{env.DOTFILES_ROOT}}"
run = '''
echo "üëÄ Watching for changes in .org files..."
echo "Press Ctrl+C to stop"
fswatch -o **/*.org | while read -r event; do
    echo "‚Üí Change detected, tangling..."
    mise run tangle && echo "‚úì Tangle complete"
done
'''

[tasks.tangle-changed]
description = "Tangle only modified org files"
dir = "{{env.DOTFILES_ROOT}}"
run = '''
CHANGED_ORG_FILES=$(git diff --name-only HEAD | grep '.org$' || true)

if [ -z "$CHANGED_ORG_FILES" ]; then
    echo "No modified org files to tangle"
    exit 0
fi

echo "Tangling modified org files:"
for file in $CHANGED_ORG_FILES; do
    if [ -f "$file" ]; then
        echo "  ‚Üí $file"
        emacs --batch "$file" --eval '(org-babel-tangle)' 2>/dev/null
    fi
done

echo "‚úì Modified org files tangled"
'''

[tasks.reload-shell]
description = "Reload shell configuration"
run = '''
echo "Reloading shell configuration..."
exec "$SHELL" -l
'''

[tasks.clean-tangled]
description = "Remove all tangled configuration files"
dir = "{{env.DOTFILES_ROOT}}"
run = '''
echo "‚ö†Ô∏è  This will remove all tangled configuration files"
read -p "Continue? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Clean cancelled"
    exit 1
fi

echo "Cleaning tangled files..."
rm -f tmux/.config/tmux/tmux.conf tmux/.config/tmux/tmux-*.conf
rm -f wezterm/.config/wezterm/wezterm.lua
rm -f aerospace/.config/aerospace/aerospace.toml
rm -f starship/.config/starship.toml
rm -f git/.config/git/.gitconfig
rm -f nvim/.config/nvim/init.lua nvim/.config/nvim/lua/*.lua
rm -f emacs/.config/emacs/early-init.el emacs/.config/emacs/config.el
rm -f zsh/.config/zsh/.zshenv zsh/.config/zsh/.zprofile zsh/.config/zsh/.zshrc zsh/.config/zsh/aliases
rm -f mise/config.toml

echo "‚úì Tangled files removed"
echo "Run 'mise run tangle' to regenerate configurations"
'''
